// apps/api/prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id           String   @id @default(uuid())
  email        String   @unique
  passwordHash String   @map("password_hash")
  fullName     String   @map("full_name")
  role         UserRole @default(VIEWER)
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@map("users")
}

enum UserRole {
  ADMIN
  MANAGER
  OPERATOR
  VIEWER
}

model Stock {
  id            String   @id @default(cuid())
  stockCode     String   @unique @map("stock_code")
  stockName     String   @map("stock_name")
  barcode       String?
  groupCode     String?  @map("group_code")
  unitOfMeasure String   @default("Adet") @map("unit_of_measure")
  purchasePrice Decimal  @default(0) @map("purchase_price") @db.Decimal(18, 4)
  salePrice     Decimal  @default(0) @map("sale_price") @db.Decimal(18, 4)
  vatRate       Decimal  @default(20) @map("vat_rate") @db.Decimal(5, 2)
  currentStock  Decimal  @default(0) @map("current_stock") @db.Decimal(18, 4)
  minStockLevel Decimal  @default(0) @map("min_stock_level") @db.Decimal(18, 4)
  maxStockLevel Decimal  @default(0) @map("max_stock_level") @db.Decimal(18, 4)
  category      String?
  brand         String?
  isActive      Boolean  @default(true) @map("is_active")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  @@map("stocks")
}

model EntityMetadata {
  id          String          @id @default(cuid())
  slug        String          @unique
  displayName String          @map("display_name")
  description String?
  tableName   String          @map("table_name")
  version     Int             @default(1)
  isActive    Boolean         @default(true) @map("is_active")
  createdAt   DateTime        @default(now()) @map("created_at")
  updatedAt   DateTime        @updatedAt @map("updated_at")
  fields      FieldMetadata[]

  @@map("entity_metadata")
}

model FieldMetadata {
  id           String          @id @default(cuid())
  entityId     String          @map("entity_id")
  name         String
  label        String
  fieldType    String          @map("field_type")
  placeholder  String?
  defaultValue Json?           @map("default_value")
  required     Boolean         @default(false)
  min          Decimal?        @db.Decimal(18, 4)
  max          Decimal?        @db.Decimal(18, 4)
  minLength    Int?            @map("min_length")
  maxLength    Int?            @map("max_length")
  pattern      String?
  options      Json?
  group        String?
  order        Int             @default(0)
  colSpan      Int?            @default(1) @map("col_span")
  visible      Boolean         @default(true)
  disabled     Boolean         @default(false)
  helpText     String?         @map("help_text")
  createdAt    DateTime        @default(now()) @map("created_at")
  updatedAt    DateTime        @updatedAt @map("updated_at")

  entity EntityMetadata @relation(fields: [entityId], references: [id], onDelete: Cascade)

  @@unique([entityId, name])
  @@map("field_metadata")
}

model AuditLog {
  id         String   @id @default(uuid())
  entityType String   @map("entity_type")
  entityId   String   @map("entity_id")
  action     String   // CREATE, UPDATE, DELETE
  userId     String?  @map("user_id")
  oldData    Json?    @map("old_data")
  newData    Json?    @map("new_data")
  changes    Json?
  metadata   Json?
  durationMs Int?     @map("duration_ms")
  ipAddress  String?  @map("ip_address")
  endpoint   String?
  createdAt  DateTime @default(now())

  @@index([entityType, entityId])
  @@index([userId])
  @@map("audit_logs")
}

model EventOutbox {
  id            String   @id @default(cuid())
  eventType     String   @map("event_type")
  aggregateType String?  @map("aggregate_type")
  aggregateId   String?  @map("aggregate_id")
  payload       Json
  status        String   @default("PENDING")
  createdAt     DateTime @default(now()) @map("created_at")

  @@index([status])
  @@map("event_outbox")
}
