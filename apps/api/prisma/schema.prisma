// apps/api/prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id           String   @id @default(uuid())
  email        String   @unique
  passwordHash String   @map("password_hash")
  fullName     String   @map("full_name")
  role         UserRole @default(VIEWER)
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@map("users")
}

enum UserRole {
  ADMIN
  MANAGER
  OPERATOR
  VIEWER
}

model Stock {
  id            String   @id @default(cuid())
  stockCode     String   @unique @map("stock_code")
  stockName     String   @map("stock_name")
  barcode       String?
  groupCode     String?  @map("group_code")
  unitOfMeasure String   @default("Adet") @map("unit_of_measure")
  purchasePrice Decimal  @default(0) @map("purchase_price") @db.Decimal(18, 4)
  salePrice     Decimal  @default(0) @map("sale_price") @db.Decimal(18, 4)
  vatRate       Decimal  @default(20) @map("vat_rate") @db.Decimal(5, 2)
  currentStock  Decimal  @default(0) @map("current_stock") @db.Decimal(18, 4)
  minStockLevel Decimal  @default(0) @map("min_stock_level") @db.Decimal(18, 4)
  maxStockLevel Decimal  @default(0) @map("max_stock_level") @db.Decimal(18, 4)
  category      String?
  brand         String?
  isActive      Boolean  @default(true) @map("is_active")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  @@map("stocks")
}

model EntityMetadata {
  id          String          @id @default(cuid())
  slug        String          @unique
  displayName String          @map("display_name")
  description String?
  tableName   String          @map("table_name")
  version     Int             @default(1)
  isActive    Boolean         @default(true) @map("is_active")
  createdAt   DateTime        @default(now()) @map("created_at")
  updatedAt   DateTime        @updatedAt @map("updated_at")
  fields      FieldMetadata[]

  @@map("entity_metadata")
}

model FieldMetadata {
  id           String          @id @default(cuid())
  entityId     String          @map("entity_id")
  name         String
  label        String
  fieldType    String          @map("field_type")
  placeholder  String?
  defaultValue Json?           @map("default_value")
  required     Boolean         @default(false)
  min          Decimal?        @db.Decimal(18, 4)
  max          Decimal?        @db.Decimal(18, 4)
  minLength    Int?            @map("min_length")
  maxLength    Int?            @map("max_length")
  pattern      String?
  options      Json?
  group        String?
  order        Int             @default(0)
  colSpan      Int?            @default(1) @map("col_span")
  visible      Boolean         @default(true)
  disabled     Boolean         @default(false)
  helpText     String?         @map("help_text")
  createdAt    DateTime        @default(now()) @map("created_at")
  updatedAt    DateTime        @updatedAt @map("updated_at")

  entity EntityMetadata @relation(fields: [entityId], references: [id], onDelete: Cascade)

  @@unique([entityId, name])
  @@map("field_metadata")
}

model AuditLog {
  id         String   @id @default(uuid())
  entityType String   @map("entity_type")
  entityId   String   @map("entity_id")
  action     String   // CREATE, UPDATE, DELETE
  userId     String?  @map("user_id")
  oldData    Json?    @map("old_data")
  newData    Json?    @map("new_data")
  changes    Json?
  metadata   Json?
  durationMs Int?     @map("duration_ms")
  ipAddress  String?  @map("ip_address")
  endpoint   String?
  createdAt  DateTime @default(now())

  @@index([entityType, entityId])
  @@index([userId])
  @@map("audit_logs")
}

model EventOutbox {
  id            String   @id @default(cuid())
  eventType     String   @map("event_type")
  aggregateType String?  @map("aggregate_type")
  aggregateId   String?  @map("aggregate_id")
  payload       Json
  status        String   @default("PENDING")
  createdAt     DateTime @default(now()) @map("created_at")

  @@index([status])
  @@map("event_outbox")
}

// ─── Üretim Yönetim Sistemi ────────────────────────────────────────

enum ProductionOrderStatus {
  DRAFT
  PLANNED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum BatchStatus {
  PENDING
  IN_PRODUCTION
  QC_PENDING
  QC_PASSED
  QC_FAILED
  RELEASED
  REJECTED
}

enum MaterialType {
  RAW_MATERIAL
  PACKAGING
  SEMI_FINISHED
  FINISHED_PRODUCT
}

enum MaterialBatchStatus {
  AVAILABLE
  RESERVED
  QUARANTINE
  EXPIRED
  CONSUMED
}

model Supplier {
  id            String   @id @default(cuid())
  code          String   @unique @map("supplier_code")
  name          String
  contactPerson String?  @map("contact_person")
  email         String?
  phone         String?
  address       String?
  city          String?
  country       String?  @default("Türkiye")
  taxNumber     String?  @map("tax_number")
  isActive      Boolean  @default(true) @map("is_active")
  leadTimeDays  Int?     @default(7) @map("lead_time_days")
  notes         String?
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  materials Material[]

  @@map("suppliers")
}

model Material {
  id               String       @id @default(cuid())
  code             String       @unique @map("material_code")
  name             String
  type             MaterialType @default(RAW_MATERIAL)
  unitOfMeasure    String       @default("Kg") @map("unit_of_measure")
  unitPrice        Decimal      @default(0) @map("unit_price") @db.Decimal(18, 4)
  currency         String       @default("TRY")
  currentStock     Decimal      @default(0) @map("current_stock") @db.Decimal(18, 4)
  minStockLevel    Decimal      @default(0) @map("min_stock_level") @db.Decimal(18, 4)
  moq              Decimal?     @db.Decimal(18, 4)
  supplierId       String?      @map("supplier_id")
  category         String?
  casNumber        String?      @map("cas_number")
  shelfLife        Int?         @map("shelf_life")
  storageCondition String?      @map("storage_condition")
  isActive         Boolean      @default(true) @map("is_active")
  notes            String?
  createdAt        DateTime     @default(now()) @map("created_at")
  updatedAt        DateTime     @updatedAt @map("updated_at")

  supplier    Supplier?    @relation(fields: [supplierId], references: [id])
  recipeItems RecipeItem[]
  batches     MaterialBatch[]

  @@index([isActive])
  @@map("materials")
}

model MaterialBatch {
  id                String              @id @default(cuid())
  batchNumber       String              @unique @map("batch_number")
  materialId        String              @map("material_id")
  supplierLotNo     String?             @map("supplier_lot_no")
  manufacturingDate DateTime?           @map("manufacturing_date")
  expiryDate        DateTime?           @map("expiry_date")
  quantity          Decimal             @default(0) @db.Decimal(18, 4)
  remainingQuantity Decimal             @default(0) @map("remaining_quantity") @db.Decimal(18, 4)
  status            MaterialBatchStatus @default(AVAILABLE)
  storageLocation   String?             @map("storage_location")
  createdAt         DateTime            @default(now()) @map("created_at")
  updatedAt         DateTime            @updatedAt @map("updated_at")

  material Material @relation(fields: [materialId], references: [id], onDelete: Cascade)
  consumptions ProductionBatchConsumption[]

  @@index([batchNumber])
  @@index([materialId])
  @@index([expiryDate])
  @@index([status])
  @@map("material_batches")
}

model Product {
  id            String   @id @default(cuid())
  code          String   @unique @map("product_code")
  name          String
  description   String?
  category      String?
  unitOfMeasure String   @default("Adet") @map("unit_of_measure")
  salePrice     Decimal  @default(0) @map("sale_price") @db.Decimal(18, 4)
  costPrice     Decimal  @default(0) @map("cost_price") @db.Decimal(18, 4)
  currency      String   @default("TRY")
  currentStock  Decimal  @default(0) @map("current_stock") @db.Decimal(18, 4)
  batchSize     Decimal  @default(1) @map("batch_size") @db.Decimal(18, 4)
  profitMargin  Decimal? @map("profit_margin") @db.Decimal(5, 2)
  barcode       String?
  isActive      Boolean  @default(true) @map("is_active")
  imageUrl      String?  @map("image_url")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  recipes          Recipe[]
  productionOrders ProductionOrder[]

  @@index([isActive])
  @@map("products")
}

model Recipe {
  id           String    @id @default(cuid())
  code         String    @unique @map("recipe_code")
  name         String
  productId    String    @map("product_id")
  version      Int       @default(1)
  batchSize    Decimal   @default(1) @map("batch_size") @db.Decimal(18, 4)
  batchUnit    String    @default("Kg") @map("batch_unit")
  totalCost    Decimal   @default(0) @map("total_cost") @db.Decimal(18, 4)
  currency     String    @default("TRY")
  instructions String?
  isActive     Boolean   @default(true) @map("is_active")
  approvedBy   String?   @map("approved_by")
  approvedAt   DateTime? @map("approved_at")
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")

  product          Product           @relation(fields: [productId], references: [id])
  items            RecipeItem[]
  productionOrders ProductionOrder[]

  @@map("recipes")
}

model RecipeItem {
  id             String  @id @default(cuid())
  recipeId       String  @map("recipe_id")
  materialId     String  @map("material_id")
  quantity       Decimal @map("quantity") @db.Decimal(18, 4)
  unit           String  @default("Kg")
  wastagePercent Decimal @default(0) @map("wastage_percent") @db.Decimal(5, 2)
  unitCost       Decimal @default(0) @map("unit_cost") @db.Decimal(18, 4)
  totalCost      Decimal @default(0) @map("total_cost") @db.Decimal(18, 4)
  notes          String?
  order          Int     @default(0)
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  recipe   Recipe   @relation(fields: [recipeId], references: [id], onDelete: Cascade)
  material Material @relation(fields: [materialId], references: [id])
  consumptions ProductionBatchConsumption[]

  @@unique([recipeId, materialId])
  @@map("recipe_items")
}

model ProductionOrder {
  id              String                @id @default(cuid())
  orderNumber     String                @unique @map("order_number")
  productId       String                @map("product_id")
  recipeId        String                @map("recipe_id")
  plannedQuantity Decimal               @map("planned_quantity") @db.Decimal(18, 4)
  actualQuantity  Decimal?              @map("actual_quantity") @db.Decimal(18, 4)
  unit            String                @default("Adet")
  status          ProductionOrderStatus @default(DRAFT)
  priority        Int                   @default(0)
  plannedStart    DateTime?             @map("planned_start")
  plannedEnd      DateTime?             @map("planned_end")
  actualStart     DateTime?             @map("actual_start")
  actualEnd       DateTime?             @map("actual_end")
  assignedTo      String?               @map("assigned_to")
  notes           String?
  createdAt       DateTime              @default(now()) @map("created_at")
  updatedAt       DateTime              @updatedAt @map("updated_at")

  product Product           @relation(fields: [productId], references: [id])
  recipe  Recipe             @relation(fields: [recipeId], references: [id])
  batches ProductionBatch[]

  @@index([status])
  @@index([plannedStart])
  @@map("production_orders")
}

model ProductionBatch {
  id                String      @id @default(cuid())
  batchNumber       String      @unique @map("batch_number")
  productionOrderId String      @map("production_order_id")
  quantity          Decimal     @map("quantity") @db.Decimal(18, 4)
  unit              String      @default("Adet")
  status            BatchStatus @default(PENDING)
  manufacturingDate DateTime?   @map("manufacturing_date")
  expiryDate        DateTime?   @map("expiry_date")
  qcDate            DateTime?   @map("qc_date")
  qcNotes           String?     @map("qc_notes")
  qcApprovedBy      String?     @map("qc_approved_by")
  productionLocation String?    @map("production_location")
  storageLocation   String?     @map("storage_location")
  notes             String?
  createdAt         DateTime    @default(now()) @map("created_at")
  updatedAt         DateTime    @updatedAt @map("updated_at")

  productionOrder ProductionOrder @relation(fields: [productionOrderId], references: [id])
  consumptions    ProductionBatchConsumption[]

  @@index([status])
  @@index([manufacturingDate])
  @@index([createdAt])
  @@map("production_batches")
}

model ProductionBatchConsumption {
  id                      String   @id @default(cuid())
  productionBatchId       String   @map("production_batch_id")
  materialBatchId         String   @map("material_batch_id")
  recipeItemId            String?  @map("recipe_item_id")
  consumedQuantity        Decimal  @map("consumed_quantity") @db.Decimal(18, 4)
  unit                    String   @default("Kg")
  timestamp               DateTime @default(now())
  materialStorageLocation String?  @map("material_storage_location")
  createdAt               DateTime @default(now()) @map("created_at")
  updatedAt               DateTime @updatedAt @map("updated_at")

  productionBatch ProductionBatch @relation(fields: [productionBatchId], references: [id], onDelete: Cascade)
  materialBatch   MaterialBatch   @relation(fields: [materialBatchId], references: [id])
  recipeItem      RecipeItem?     @relation(fields: [recipeItemId], references: [id])

  @@index([productionBatchId])
  @@index([materialBatchId])
  @@index([recipeItemId])
  @@index([timestamp])
  @@map("production_batch_consumptions")
}
